services:
  db:
    image: mcr.microsoft.com/azure-sql-edge
    environment:
      ACCEPT_EULA: "1"
      MSSQL_SA_PASSWORD: ${MSSQL_PASSWORD}
    ports:
      - "1433:1433"
    volumes:
      - db_data:/var/opt/mssql
  
  api:
    build:
      context: ./backend/src
      dockerfile: "Dockerfile"
    container_name: notes-api
    environment:
      ASPNETCORE_ENVIRONMENT: "Production"
      ConnectionStrings__DefaultConnection: "${CONNECTION_STRING}"
      JwtSettings__Issuer: "https://michaeldick.io"
      JwtSettings__Audience: "https://michaeldick.io"
      JwtSettings__Secret: "${JWT_SECRET}"
      Recaptcha__SecretKey: "${RECAPTCHA_SECRET}"
      AWS__Region: "us-east-2"
      AWS__Profile: "default"
    ports:
      - "5003:8080"
    depends_on:
      - db
  frontend_builder:
    image: node:18
    working_dir: /app
    volumes:
      - ./frontend/src/website-frontend:/app:cached
      - frontend_dist:/srv/site
    command: /bin/sh -lc "npm ci && npm run build && cp -r ./dist/* /srv/site/"
  web: 
    image: caddy:2 # Offical Caddy web server from Docker Hub.
    container_name: notes-web
    ports:
      - "80:80"
    volumes: 
      # Caddy configurations. ro means read only, container cannot modify this file.
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # static files for the frontend build.
      - ./frontend/src/website-frontend/dist:/srv/site:ro
    depends_on:
      - api
      - frontend_builder
volumes:
  db_data:
  frontend_dist: